<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encontristas</title>
    <link rel="shortcut icon" href="../assets/3.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .filter-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }

        .btn-export {
            background: linear-gradient(45deg, #3d7517, #3d7517);
            color: white;
            border: none;
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .badge-pago {
            background-color: #28a745;
        }

        .badge-pendente {
            background-color: #ffc107;
        }

        .btn-voltar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar:hover {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .btn-voltar .material-icons {
            font-size: 24px;
        }

        .table-container {
            position: relative;
            margin-bottom: 30px;
        }

        /* Estilos específicos para DataTables */
        .dataTables_wrapper .dataTables_scrollHead table {
            margin-bottom: 0 !important;
        }

        .dataTables_wrapper .dataTables_scrollBody {
            border-top: 1px solid #dee2e6;
        }

        /* Garantir que o cabeçalho fique fixo */
        .dataTables_wrapper .dataTables_scrollHead {
            background-color: #343a40;
            color: white;
        }

        /* Ajustar largura das colunas */
        #participantesTable thead th,
        #participantesTable tbody td {
            white-space: nowrap;
            padding: 0.75rem;
        }

        /* Garantir que os controles de pesquisa fiquem fora da área de rolagem */
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            position: relative;
            z-index: 20;
            background-color: #fff;
            padding: 5px 0;
        }

        /* Ajustar o espaçamento entre os controles e a tabela */
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 10px;
        }

        /* Garantir que o título da tabela fique fixo */
        .container h3 {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 30;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        /* Garantir que o cabeçalho e o corpo da tabela tenham a mesma largura */
        #participantesTable thead th,
        #participantesTable tbody td {
            white-space: nowrap;
            min-width: 100px;
        }

        /* Melhora a aparência da tabela com rolagem */
        #participantesTable {
            width: 100% !important;
            margin-bottom: 0;
        }

        /* Ocultar botões automáticos do DataTables */
        .dt-buttons {
            display: none !important;
        }

        /* Adicionar no bloco <style> existente */
        .badge-parcial {
            background-color: #fd7e14;
            /* Laranja para pagamento parcial */
        }

        .pagamento-info {
            min-width: 120px;
            text-align: center;
        }

        .valores-pagamento {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .progress-sm {
            height: 4px;
        }

        .progress {
            background-color: #e9ecef;
            border-radius: 2px;
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Ajustar largura da coluna de pagamento */
        #participantesTable thead th:nth-child(6),
        #participantesTable tbody td:nth-child(6) {
            min-width: 140px;
            white-space: nowrap;
        }

        /* Estilos para edição no modal */
.campo-edicao {
    margin-top: 5px;
    font-size: 0.9rem;
}

.campo-visualizacao {
    display: inline-block;
    min-height: 1.2em;
}

.modo-edicao .campo-visualizacao {
    display: none !important;
}

.modo-edicao .campo-edicao {
    display: block !important;
}

/* Destacar campos em edição */
.campo-edicao:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

/* Estilo para indicar modo de edição */
.modo-edicao .modal-header {
    background-color: #fff3cd;
    border-bottom: 1px solid #ffeaa7;
}

.modo-edicao .modal-title::after {
    content: " (Editando)";
    color: #856404;
    font-weight: normal;
    font-size: 0.9em;
}


    </style>
</head>

<body>
    <!-- CABEÇALHO -->
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">ENCONTRISTAS INSCRITOS</h2>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="container mt-5">
        <!-- Cabeçalho Título + Download Excel -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h3>Lista dos Encontristas Inscritos</h3>
            </div>
            <div class="col-md-4 text-right">
                <button class="btn btn-export mr-2" id="btnExportarCompleto">
                    <i class="material-icons align-middle">file_download</i> Exportar Excel
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-card">
            <form id="filterForm" class="row">
                <!-- Filtro Status de Pagamento -->
                <div class="form-group col-md-3">
                    <label for="filterPagamento">Status Pagamento</label>
                    <select class="form-control" id="filterPagamento">
                        <option value="">Todos</option>
                        <option value="pago">Pago</option>
                        <option value="parcial">Parcial</option>
                        <option value="pendente">Pendente</option>
                    </select>
                </div>
                <!-- Filtro Igreja -->
                <div class="form-group col-md-3">
                    <label for="filterIgreja">Igreja</label>
                    <select class="form-control" id="filterIgreja">
                        <option value="">Todas</option>
                        <option value="IEB Intermares">IEB Intermares</option>
                        <option value="IEB Cidade Verde">IEB Cidade Verde</option>
                        <option value="IEB Vila Feliz">IEB Vila Feliz</option>
                        <option value="IEB Missão Resgate">IEB Missão Resgate</option>
                        <option value="Outra">Outra Igreja</option>
                    </select>
                </div>
                <!-- Botões -->
                <div class="form-group col-md-3 d-flex align-items-end">
                    <!-- Filtrar -->
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons align-middle">search</i> Filtrar
                    </button>
                    <!-- Limpar -->
                    <button type="button" class="btn btn-outline-secondary ml-2" id="limparFiltro">
                        Limpar
                    </button>
                </div>
            </form>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-striped" id="participantesTable">
                    <thead class="thead-dark">
                        <tr>
                            <th>Código</th>
                            <th>Nome</th>
                            <th>Celular</th>
                            <th>Igreja</th>
                            <th>Célula</th>
                            <th>Pagamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="participantesList">
                        <!-- Os dados serão carregados dinamicamente do Firebase -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rodapé -->
        <div class="row mt-3 mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <strong>Total de participantes:</strong> <span id="contador-participantes">0</span>
                        <span id="texto-filtro" class="ml-2 text-muted font-italic" style="display: none;">(filtrados de
                            <span id="total-participantes">0</span>)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes-->
        <!-- Modal de Detalhes-->
        <div class="modal fade" id="participanteModal" tabindex="-1" role="dialog"
            aria-labelledby="participanteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <!-- Cabeçalho -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="participanteModalLabel">Dados do Encontrista</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <!-- Dados -->
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Informações Pessoais</h6>
                                <hr>
                                <p><strong>Código:</strong> <span id="modalCodigo"></span></p>

                                <p><strong>Nome:</strong>
                                    <span id="modalNome" class="campo-visualizacao"></span>
                                    <input type="text" id="modalNomeEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p><strong>Data de Nascimento:</strong>
                                    <span id="modalDtNasc" class="campo-visualizacao"></span>
                                    <input type="date" id="modalDtNascEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p><strong>CPF:</strong>
                                    <span id="modalCpf" class="campo-visualizacao"></span>
                                    <input type="text" id="modalCpfEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p><strong>Sexo:</strong>
                                    <span id="modalSexo" class="campo-visualizacao"></span>
                                    <select id="modalSexoEdit" class="form-control campo-edicao" style="display: none;">
                                        <option value="Masculino">Masculino</option>
                                        <option value="Feminino">Feminino</option>
                                    </select>
                                </p>

                                <p><strong>Email:</strong>
                                    <span id="modalEmail" class="campo-visualizacao"></span>
                                    <input type="email" id="modalEmailEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p><strong>Celular:</strong>
                                    <span id="modalCelular" class="campo-visualizacao"></span>
                                    <input type="tel" id="modalCelularEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p><strong>Tamanho da Blusa:</strong>
                                    <span id="modalTamanhoBlusa" class="campo-visualizacao"></span>
                                    <select id="modalTamanhoBlusaEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                        <option value="PP">PP</option>
                                        <option value="P">P</option>
                                        <option value="M">M</option>
                                        <option value="G">G</option>
                                        <option value="GG">GG</option>
                                        <option value="XG">XG</option>
                                        <option value="XGG">XGG</option>
                                    </select>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Informações de Saúde</h6>
                                <hr>
                                <p><strong>Tipo Sanguíneo:</strong> <span id="modalTipoSanguineo"></span></p>
                                <p><strong>Tem Alergia:</strong> <span id="modalAlergia"></span></p>
                                <p><strong>Quais Alergias:</strong> <span id="modalQuaisAlergias"></span></p>
                                <p><strong>Problema de Saúde:</strong> <span id="modalProblemaSaude"></span></p>
                                <p><strong>Quais Problemas:</strong> <span id="modalQuaisProblemas"></span></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Informações da Igreja</h6>
                                <hr>

                                <p><strong>Igreja:</strong>
                                    <span id="modalIgreja" class="campo-visualizacao"></span>
                                    <select id="modalIgrejaEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                        <option value="IEB Intermares">IEB Intermares</option>
                                        <option value="IEB Cidade Verde">IEB Cidade Verde</option>
                                        <option value="IEB Vila Feliz">IEB Vila Feliz</option>
                                        <option value="IEB Missão Resgate">IEB Missão Resgate</option>
                                        <option value="Outra">Outra Igreja</option>
                                    </select>
                                </p>

                                <p id="modalOutraIgrejaContainer"><strong>Outra Igreja:</strong>
                                    <span id="modalOutraIgreja" class="campo-visualizacao"></span>
                                    <input type="text" id="modalOutraIgrejaEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p id="modalNomePastorContainer"><strong>Nome do Pastor:</strong>
                                    <span id="modalNomePastor" class="campo-visualizacao"></span>
                                    <input type="text" id="modalNomePastorEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                </p>

                                <p id="modalCelulaContainer"><strong>Célula:</strong>
                                    <span id="modalCelula" class="campo-visualizacao"></span>
                                    <select id="modalCelulaEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                        <option value="">Selecione Sua Célula...</option>
                                        <option value="Sem Célula">Sem Célula</option>
                                        <option value="ADRIANA / KENEDY">ADRIANA / KENEDY</option>
                                        <option value="AIRTON / EMÍLIA">AIRTON / EMÍLIA</option>
                                        <option value="ALDA">ALDA</option>
                                        <option value="ALLAN / AILDA">ALLAN / AILDA</option>
                                        <option value="ANA / JOYCE / AMANDA">ANA / JOYCE / AMANDA</option>
                                        <option value="ANDERSON / LAURISA">ANDERSON / LAURISA</option>
                                        <option value="ARTHUR / LORENA">ARTHUR / LORENA</option>
                                        <option value="BELMIRO / MÔNICA">BELMIRO / MÔNICA</option>
                                        <option value="BERNADETE / FRANCY">BERNADETE / FRANCY</option>
                                        <option value="CAIO / BIANCA">CAIO / BIANCA</option>
                                        <option value="CLÁUDIO / JAQUELINE">CLÁUDIO / JAQUELINE</option>
                                        <option value="CLOVILDA / JOSIMAR">CLOVILDA / JOSIMAR</option>
                                        <option value="CLOVIS / ANDREI">CLOVIS / ANDREI</option>
                                        <option value="DANIEL / EVELLYN">DANIEL / EVELLYN</option>
                                        <option value="EDUARDO / NICOLLY">EDUARDO / NICOLLY</option>
                                        <option value="FÁBIO / EDNALVA">FÁBIO / EDNALVA</option>
                                        <option value="FABRÍCIO / NADJA">FABRÍCIO / NADJA</option>
                                        <option value="FERNANDES / ZELÂNDIA">FERNANDES / ZELÂNDIA</option>
                                        <option value="GABRIEL / BARBARA">GABRIEL / BARBARA</option>
                                        <option value="GABRIEL / RAYZA">GABRIEL / RAYZA</option>
                                        <option value="GILBERTO / MARCIA">GILBERTO / MARCIA</option>
                                        <option value="GUILHERME / MIGUEL">GUILHERME / MIGUEL</option>
                                        <option value="GUSTAVO / MARIANA">GUSTAVO / MARIANA</option>
                                        <option value="GUTEMBERG / ELAINE">GUTEMBERG / ELAINE</option>
                                        <option value="JAIRO / ROSANA">JAIRO / ROSANA</option>
                                        <option value="JOHN">JOHN</option>
                                        <option value="JONATHAN / ALINE">JONATHAN / ALINE</option>
                                        <option value="JOSINALDO / ELAINE">JOSINALDO / ELAINE</option>
                                        <option value="JÚNIOR / FERNANDA">JÚNIOR / FERNANDA</option>
                                        <option value="LEONARDO / LIDIA">LEONARDO / LIDIA</option>
                                        <option value="LINDEMBERG / ADRIANA / LUCIENE">LINDEMBERG / ADRIANA / LUCIENE
                                        </option>
                                        <option value="LÍVIA / NICOLY">LÍVIA / NICOLY</option>
                                        <option value="LUCAS / SAYMON">LUCAS / SAYMON</option>
                                        <option value="MANOEL / CLAUDIANE">MANOEL / CLAUDIANE</option>
                                        <option value="MARCIELLE / PIETRA">MARCIELLE / PIETRA</option>
                                        <option value="NATIVA">NATIVA</option>
                                        <option value="PATRÍCIA">PATRÍCIA</option>
                                        <option value="PEDRO / FILIPE">PEDRO / FILIPE</option>
                                        <option value="RAMON / NAZELIA">RAMON / NAZELIA</option>
                                        <option value="RAQUEL">RAQUEL</option>
                                        <option value="REBEKAH / MONIQUE">REBEKAH / MONIQUE</option>
                                        <option value="RHODNEY / KAREN">RHODNEY / KAREN</option>
                                        <option value="RIBAMAR / JOSELMA">RIBAMAR / JOSELMA</option>
                                        <option value="RICARDO / ROSANE">RICARDO / ROSANE</option>
                                        <option value="ROGÉRIO / LUCIÉLLEN">ROGÉRIO / LUCIÉLLEN</option>
                                        <option value="RUBENS / EMILLY">RUBENS / EMILLY</option>
                                        <option value="SAMUEL / RAISSA">SAMUEL / RAISSA</option>
                                        <option value="SAULO / ERIKA">SAULO / ERIKA</option>
                                        <option value="SIMONE">SIMONE</option>
                                        <option value="WALTER / JESSYKA">WALTER / JESSYKA</option>
                                        <option value="YANN / NATALIA">YANN / NATÁLIA</option>
                                    </select>
                                </p>

                                <p><strong>Situação na Igreja:</strong>
                                    <span id="modalSituacaoIgreja" class="campo-visualizacao"></span>
                                    <select id="modalSituacaoIgrejaEdit" class="form-control campo-edicao"
                                        style="display: none;">
                                        <option value="Membro">Membro</option>
                                        <option value="Recém-Convertido">Recém-Convertido</option>
                                        <option value="Afastado">Afastado</option>
                                        <option value="Não é membro">Não é membro</option>
                                    </select>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Contatos de Emergência</h6>
                                <hr>
                                <p><strong>Contato 1:</strong> <span id="modalContato1"></span></p>
                                <p><strong>Telefone 1:</strong> <span id="modalFoneContato1"></span></p>
                                <p><strong>Contato 2:</strong> <span id="modalContato2"></span></p>
                                <p><strong>Telefone 2:</strong> <span id="modalFoneContato2"></span></p>
                                <p><strong>Contato 3:</strong> <span id="modalContato3"></span></p>
                                <p><strong>Telefone 3:</strong> <span id="modalFoneContato3"></span></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h6>Informações de Registro</h6>
                                <hr>
                                <p><strong>Status Pagamento:</strong> <span id="modalStatusPagamento"></span></p>
                                <p><strong>Data de Preenchimento:</strong> <span id="modalDataPreenchimento"></span></p>
                                <p><strong>Data de Registro:</strong> <span id="modalDtRegistro"></span></p>
                                <p><strong>Ano do Evento:</strong> <span id="modalAnoEvento"></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- Botões -->
                    <div class="modal-footer">
                        <!-- Botões do modo visualização -->
                        <div id="botoesVisualizacao">
                            <button type="button" class="btn btn-warning" id="btnEditarParticipante">
                                <i class="material-icons align-middle">edit</i> Editar Dados
                            </button>
                            <button type="button" class="btn btn-danger" id="btnExcluirParticipante">
                                <i class="material-icons align-middle">delete</i> Excluir Participante
                            </button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>

                        <!-- Botões do modo edição -->
                        <div id="botoesEdicao" style="display: none;">
                            <button type="button" class="btn btn-success" id="btnSalvarEdicao">
                                <i class="material-icons align-middle">save</i> Salvar Alterações
                            </button>
                            <button type="button" class="btn btn-secondary" id="btnCancelarEdicao">
                                <i class="material-icons align-middle">cancel</i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="../firebase/firebaseConfig.js"></script>

    <script>

        // Inicialização do DataTable
        let dataTable;
        let totalParticipantes = 0;
        let dadosCompletos = []; // Array para armazenar todos os dados para exportação

        //Modal e gestão do doc
        $(document).ready(function () {
            // Carregar participantes do Firebase
            carregarParticipantes();

            // Inicializar DataTable SEM botões automáticos
            dataTable = $('#participantesTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
                },
                responsive: false,
                dom: 'frti', // Removido 'B' para não mostrar botões automáticos
                paging: false,
                fixedHeader: false,
                data: [],
                columns: [
                    { title: "Código", width: "10%" },
                    { title: "Nome", width: "25%" },
                    { title: "Celular", width: "15%" },
                    { title: "Igreja", width: "20%" },
                    { title: "Célula", width: "15%" },
                    { title: "Pagamento", width: "10%" },
                    { title: "Ações", width: "5%" }
                ],
                drawCallback: function () {
                    atualizarContador();
                }
            });

            // Botão de exportação completa personalizada
            $('#btnExportarCompleto').on('click', function () {
                exportarExcelProfissional();
            });

            // Filtrar participantes
            $('#filterForm').on('submit', function (e) {
                e.preventDefault();
                aplicarFiltros();
            });

            // Limpar filtros
            $('#limparFiltro').on('click', function () {
                $('#filterForm')[0].reset();
                aplicarFiltros();
            });

            // Adicione este código ao seu script existente
            $('#participanteModal').on('hide.bs.modal', function (e) {
                // Remover o foco de todos os elementos focáveis dentro do modal
                $(this).find('button, input, select, textarea, a[href]').blur();
            });

            // Configurar o botão de exclusão
            $('#btnExcluirParticipante').on('click', function () {
                const participanteId = $(this).data('id');

                if (!participanteId) {
                    alert("Erro: Não foi possível identificar o participante para exclusão.");
                } else {
                    excluirParticipante(participanteId);
                }
            });
        });


        // Função para criar indicador visual de pagamento
        function criarIndicadorPagamento(valorPago, valorTotal) {
            const percentualPago = (valorPago / valorTotal) * 100;
            const valorRestante = valorTotal - valorPago;

            let classeStatus = '';
            let textoStatus = '';

            if (valorPago >= valorTotal) {
                classeStatus = 'badge-pago';
                textoStatus = 'PAGO';
            } else if (valorPago > 0) {
                classeStatus = 'badge-parcial';
                textoStatus = 'PARCIAL';
            } else {
                classeStatus = 'badge-pendente';
                textoStatus = 'PENDENTE';
            }

            return `
                <div class="pagamento-info">
                    <span class="badge ${classeStatus}">${textoStatus}</span>
                    <div class="valores-pagamento">
                        <small>R$ ${valorPago.toFixed(2).replace('.', ',')} / R$ ${valorTotal.toFixed(2).replace('.', ',')}</small>
                    </div>
                    <div class="progress progress-sm mt-1">
                        <div class="progress-bar ${classeStatus === 'badge-pago' ? 'bg-success' : classeStatus === 'badge-parcial' ? 'bg-warning' : 'bg-danger'}" 
                            style="width: ${Math.min(percentualPago, 100)}%"></div>
                    </div>
                </div>
            `;
        }


        // Função para Carregar participantes
        async function carregarParticipantes() {
            try {
                // Buscar inscrições
                const inscricoesSnapshot = await db.collection("Eventos").doc("ED2025").collection("inscricoes")
                    .where("anoevento", "==", "2025")
                    .where("tipoInsc", "==", "encontrista")
                    .get();

                // Buscar todos os pagamentos
                const pagamentosSnapshot = await db.collection("Eventos").doc("ED2025").collection("pagamentos").get();

                // Criar mapa de pagamentos por participante
                const pagamentosPorParticipante = {};
                pagamentosSnapshot.forEach((doc) => {
                    const pagamento = doc.data();
                    const participanteId = pagamento.participanteId || pagamento.inscricaoId;

                    if (participanteId) {
                        if (!pagamentosPorParticipante[participanteId]) {
                            pagamentosPorParticipante[participanteId] = 0;
                        }
                        pagamentosPorParticipante[participanteId] += parseFloat(pagamento.valor || 0);
                    }
                });

                // Limpar DataTable e dados completos
                dataTable.clear();
                dadosCompletos = [];

                // Armazenar o total de participantes
                totalParticipantes = inscricoesSnapshot.size;

                // Valor total esperado (você pode ajustar este valor conforme necessário)
                const VALOR_TOTAL_INSCRICAO = 350.00; // Exemplo: R$ 350,00

                inscricoesSnapshot.forEach((doc) => {
                    const participante = doc.data();
                    const participanteId = doc.id;

                    // Calcular valor pago
                    const valorPago = pagamentosPorParticipante[participanteId] || 0;

                    // Armazenar dados completos para exportação (incluindo valores)
                    dadosCompletos.push({
                        id: doc.id,
                        ...participante,
                        valorPago: valorPago,
                        valorTotal: VALOR_TOTAL_INSCRICAO,
                        valorRestante: VALOR_TOTAL_INSCRICAO - valorPago
                    });

                    // Determinar a igreja a ser exibida
                    let igrejaExibida = participante.igreja;
                    if (participante.igreja === 'Outra' && participante.outraIgreja) {
                        igrejaExibida = participante.outraIgreja;
                    }

                    // Criar indicador de pagamento
                    const indicadorPagamento = criarIndicadorPagamento(valorPago, VALOR_TOTAL_INSCRICAO);

                    // Adicionar linha ao DataTable
                    dataTable.row.add([
                        participante.codigoIdentificador || 'N/A',
                        participante.nome || 'N/A',
                        participante.celular || 'N/A',
                        igrejaExibida || 'N/A',
                        participante.celula || 'N/A',
                        indicadorPagamento,
                        `<button class="btn btn-info btn-sm" onclick="verDetalhes('${doc.id}')">Ver</button>`
                    ]);
                });

                // Renderizar DataTable
                dataTable.draw();

                // Atualizar contador
                atualizarContador();

            } catch (error) {
                console.error("Erro ao carregar participantes: ", error);
                alert("Erro ao carregar lista de participantes. Tente novamente.");
            }
        }


        // Função para exportar Excel profissional usando SheetJS
        function exportarExcelProfissional() {
            if (dadosCompletos.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }

            try {
                // Preparar dados para exportação
                const dadosExportacao = dadosCompletos.map((participante, index) => {
                    // Determinar a igreja a ser exibida
                    let igrejaExibida = participante.igreja;
                    if (participante.igreja === 'Outra' && participante.outraIgreja) {
                        igrejaExibida = participante.outraIgreja;
                    }

                    return {
                        'Nº': index + 1,
                        'Código': participante.codigoIdentificador || '',
                        'Nome Completo': participante.nome || '',
                        'Data de Nascimento': participante.dtnasc || '',
                        'CPF': participante.cpf || '',
                        'Sexo': participante.sexo || '',
                        'Email': participante.email || '',
                        'Celular': participante.celular || '',
                        'Tamanho da Blusa': participante.tamanhoBlusa || '',
                        'Igreja': igrejaExibida || '',
                        'Outra Igreja': participante.outraIgreja || '',
                        'Nome do Pastor': participante.nomePastor || '',
                        'Célula': participante.celula || '',
                        'Situação na Igreja': participante.situacaoIgreja || '',
                        'Tipo Sanguíneo': participante.tipoSanguineo || '',
                        'Tem Alergia': participante.alergia ? 'SIM' : 'NÃO',
                        'Quais Alergias': participante.quaisAlergias || '',
                        'Problema de Saúde': participante.problemaSaude ? 'SIM' : 'NÃO',
                        'Quais Problemas de Saúde': participante.quaisProblemaSaude || '',
                        'Contato 1': participante.contato1 || '',
                        'Telefone Contato 1': participante.foneContato1 || '',
                        'Contato 2': participante.contato2 || '',
                        'Telefone Contato 2': participante.foneContato2 || '',
                        'Contato 3': participante.contato3 || '',
                        'Telefone Contato 3': participante.foneContato3 || '',
                        // ✅ NOVAS COLUNAS DE PAGAMENTO
                        'Valor Pago': `R$ ${(participante.valorPago || 0).toFixed(2).replace('.', ',')}`,
                        'Valor Total': `R$ ${(participante.valorTotal || 0).toFixed(2).replace('.', ',')}`,
                        'Valor Restante': `R$ ${(participante.valorRestante || 0).toFixed(2).replace('.', ',')}`,
                        'Status Pagamento Detalhado': participante.valorPago >= participante.valorTotal ? 'PAGO' :
                            participante.valorPago > 0 ? 'PARCIAL' : 'PENDENTE',
                        'Status Pagamento': participante.statusPagamento === 'pago' ? 'PAGO' : 'PENDENTE',
                        'Data de Preenchimento': participante.dataPreenchimento || '',
                        'Data de Registro': participante.dtRegistro || '',
                        'Ano do Evento': participante.anoevento || '',
                        'Tipo de Inscrição': participante.tipoInsc || ''
                    };
                });

                // Criar workbook
                const wb = XLSX.utils.book_new();

                // Criar worksheet com os dados
                const ws = XLSX.utils.json_to_sheet(dadosExportacao);

                // Definir larguras das colunas (adicionar as novas larguras)
                const colWidths = [
                    { wch: 5 },   // Nº
                    { wch: 8 },   // Código
                    { wch: 30 },  // Nome Completo
                    { wch: 12 },  // Data de Nascimento
                    { wch: 15 },  // CPF
                    { wch: 10 },  // Sexo
                    { wch: 25 },  // Email
                    { wch: 15 },  // Celular
                    { wch: 12 },  // Tamanho da Blusa
                    { wch: 20 },  // Igreja
                    { wch: 20 },  // Outra Igreja
                    { wch: 20 },  // Nome do Pastor
                    { wch: 20 },  // Célula
                    { wch: 18 },  // Situação na Igreja
                    { wch: 12 },  // Tipo Sanguíneo
                    { wch: 10 },  // Tem Alergia
                    { wch: 25 },  // Quais Alergias
                    { wch: 15 },  // Problema de Saúde
                    { wch: 25 },  // Quais Problemas de Saúde
                    { wch: 20 },  // Contato 1
                    { wch: 15 },  // Telefone Contato 1
                    { wch: 20 },  // Contato 2
                    { wch: 15 },  // Telefone Contato 2
                    { wch: 20 },  // Contato 3
                    { wch: 15 },  // Telefone Contato 3
                    // ✅ NOVAS COLUNAS DE PAGAMENTO
                    { wch: 12 },  // Valor Pago
                    { wch: 12 },  // Valor Total
                    { wch: 12 },  // Valor Restante
                    { wch: 15 },  // Status Pagamento Detalhado
                    { wch: 12 },  // Status Pagamento
                    { wch: 15 },  // Data de Preenchimento
                    { wch: 15 },  // Data de Registro
                    { wch: 10 },  // Ano do Evento
                    { wch: 15 }   // Tipo de Inscrição
                ];

                ws['!cols'] = colWidths;

                // Aplicar estilos ao cabeçalho
                const range = XLSX.utils.decode_range(ws['!ref']);

                // Estilizar cabeçalho (primeira linha)
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;

                    ws[cellAddress].s = {
                        font: {
                            bold: true,
                            color: { rgb: "FFFFFF" },
                            sz: 12
                        },
                        fill: {
                            fgColor: { rgb: "2F5233" }
                        },
                        alignment: {
                            horizontal: "center",
                            vertical: "center"
                        },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                }

                // Estilizar dados (demais linhas)
                for (let row = 1; row <= range.e.r; row++) {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!ws[cellAddress]) continue;

                        // Cor alternada para as linhas
                        const fillColor = row % 2 === 0 ? "F8F9FA" : "FFFFFF";

                        ws[cellAddress].s = {
                            font: {
                                sz: 10
                            },
                            fill: {
                                fgColor: { rgb: fillColor }
                            },
                            alignment: {
                                horizontal: col === 0 ? "center" : "left", // Centralizar apenas a coluna Nº
                                vertical: "center",
                                wrapText: true
                            },
                            border: {
                                top: { style: "thin", color: { rgb: "E0E0E0" } },
                                bottom: { style: "thin", color: { rgb: "E0E0E0" } },
                                left: { style: "thin", color: { rgb: "E0E0E0" } },
                                right: { style: "thin", color: { rgb: "E0E0E0" } }
                            }
                        };

                        // Na parte de estilização dos dados, adicione destaque para as colunas de valores
                        // Destacar valores monetários (colunas 25, 26, 27)
                        if (col >= 25 && col <= 27) { // Colunas de valores monetários
                            ws[cellAddress].s.font.color = { rgb: "0066CC" }; // Azul para valores
                            ws[cellAddress].s.font.bold = true;
                            ws[cellAddress].s.alignment.horizontal = "right"; // Alinhar à direita
                        }

                        // Destacar status de pagamento detalhado (coluna 28)
                        if (col === 28) { // Coluna Status Pagamento Detalhado
                            const status = ws[cellAddress].v;
                            if (status === 'PAGO') {
                                ws[cellAddress].s.font.color = { rgb: "28A745" }; // Verde
                            } else if (status === 'PARCIAL') {
                                ws[cellAddress].s.font.color = { rgb: "FD7E14" }; // Laranja
                            } else {
                                ws[cellAddress].s.font.color = { rgb: "FFC107" }; // Amarelo
                            }
                            ws[cellAddress].s.font.bold = true;
                        }

                        // Destacar status de pagamento original (coluna 29)
                        if (col === 29) { // Coluna Status Pagamento
                            const isPago = ws[cellAddress].v === 'PAGO';
                            ws[cellAddress].s.font.color = { rgb: isPago ? "28A745" : "FFC107" };
                            ws[cellAddress].s.font.bold = true;
                        }

                        // Destacar campos de saúde importantes
                        if (col === 15 || col === 17) { // Colunas "Tem Alergia" e "Problema de Saúde"
                            const temProblema = ws[cellAddress].v === 'SIM';
                            if (temProblema) {
                                ws[cellAddress].s.font.color = { rgb: "DC3545" };
                                ws[cellAddress].s.font.bold = true;
                            }
                        }
                    }
                }

                // Adicionar worksheet ao workbook
                XLSX.utils.book_append_sheet(wb, ws, "Encontristas ED 2025");

                // Criar uma segunda aba com resumo
                const resumo = criarResumoEstatisticas();
                const wsResumo = XLSX.utils.json_to_sheet(resumo);

                // Larguras das colunas do resumo
                wsResumo['!cols'] = [
                    { wch: 30 },  // Categoria
                    { wch: 15 },  // Quantidade
                    { wch: 10 }   // Percentual
                ];

                XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo Estatísticas");

                // Gerar nome do arquivo com data e hora
                const agora = new Date();
                const dataHora = agora.toLocaleDateString('pt-BR').replace(/\//g, '-') + '_' +
                    agora.toLocaleTimeString('pt-BR').replace(/:/g, '-');
                const nomeArquivo = `Encontristas_ED2025_${dataHora}.xlsx`;

                // Salvar arquivo
                XLSX.writeFile(wb, nomeArquivo);

                alert(`Arquivo Excel exportado com sucesso!\nNome: ${nomeArquivo}\nTotal de registros: ${dadosCompletos.length}`);

            } catch (error) {
                console.error('Erro na exportação:', error);
                alert('Erro ao exportar arquivo Excel. Tente novamente.');
            }
        }

        // Função para criar resumo estatístico
        function criarResumoEstatisticas() {
            const total = dadosCompletos.length;

            // Contar por status de pagamento
            const pagos = dadosCompletos.filter(p => p.statusPagamento === 'pago').length;
            const pendentes = total - pagos;

            // Contar por igreja
            const igrejas = {};
            dadosCompletos.forEach(p => {
                const igreja = p.igreja === 'Outra' && p.outraIgreja ? p.outraIgreja : p.igreja;
                igrejas[igreja] = (igrejas[igreja] || 0) + 1;
            });

            // Contar por célula (apenas IEB Intermares)
            const celulas = {};
            dadosCompletos.forEach(p => {
                if (p.igreja === 'IEB Intermares' && p.celula) {
                    celulas[p.celula] = (celulas[p.celula] || 0) + 1;
                }
            });

            // Contar por sexo
            const sexos = {};
            dadosCompletos.forEach(p => {
                if (p.sexo) sexos[p.sexo] = (sexos[p.sexo] || 0) + 1;
            });

            // Contar problemas de saúde
            const comAlergia = dadosCompletos.filter(p => p.alergia === true).length;
            const comProblemaSaude = dadosCompletos.filter(p => p.problemaSaude === true).length;

            // Contar por tipo sanguíneo
            const tiposSanguineos = {};
            dadosCompletos.forEach(p => {
                if (p.tipoSanguineo && p.tipoSanguineo !== 'Não Sei') {
                    tiposSanguineos[p.tipoSanguineo] = (tiposSanguineos[p.tipoSanguineo] || 0) + 1;
                }
            });

            // Criar array de resumo
            const resumo = [
                { 'Categoria': '=== RESUMO GERAL ===', 'Quantidade': '', 'Percentual': '' },
                { 'Categoria': 'Total de Encontristas', 'Quantidade': total, 'Percentual': '100%' },
                { 'Categoria': '', 'Quantidade': '', 'Percentual': '' },

                { 'Categoria': '=== STATUS DE PAGAMENTO ===', 'Quantidade': '', 'Percentual': '' },
                { 'Categoria': 'Pagamentos Confirmados', 'Quantidade': pagos, 'Percentual': `${((pagos / total) * 100).toFixed(1)}%` },
                { 'Categoria': 'Pagamentos Pendentes', 'Quantidade': pendentes, 'Percentual': `${((pendentes / total) * 100).toFixed(1)}%` },
                { 'Categoria': '', 'Quantidade': '', 'Percentual': '' },

                { 'Categoria': '=== POR IGREJA ===', 'Quantidade': '', 'Percentual': '' }
            ];

            // Adicionar estatísticas por igreja
            Object.entries(igrejas).sort((a, b) => b[1] - a[1]).forEach(([igreja, qtd]) => {
                resumo.push({
                    'Categoria': igreja || 'Não informado',
                    'Quantidade': qtd,
                    'Percentual': `${((qtd / total) * 100).toFixed(1)}%`
                });
            });

            // Adicionar estatísticas por célula (se houver)
            if (Object.keys(celulas).length > 0) {
                resumo.push({ 'Categoria': '', 'Quantidade': '', 'Percentual': '' });
                resumo.push({ 'Categoria': '=== POR CÉLULA (IEB INTERMARES) ===', 'Quantidade': '', 'Percentual': '' });

                Object.entries(celulas).sort((a, b) => b[1] - a[1]).forEach(([celula, qtd]) => {
                    resumo.push({
                        'Categoria': celula || 'Sem célula',
                        'Quantidade': qtd,
                        'Percentual': `${((qtd / total) * 100).toFixed(1)}%`
                    });
                });
            }

            resumo.push({ 'Categoria': '', 'Quantidade': '', 'Percentual': '' });
            resumo.push({ 'Categoria': '=== POR SEXO ===', 'Quantidade': '', 'Percentual': '' });

            // Adicionar estatísticas por sexo
            Object.entries(sexos).sort((a, b) => b[1] - a[1]).forEach(([sexo, qtd]) => {
                resumo.push({
                    'Categoria': sexo || 'Não informado',
                    'Quantidade': qtd,
                    'Percentual': `${((qtd / total) * 100).toFixed(1)}%`
                });
            });

            // Adicionar estatísticas de saúde
            resumo.push({ 'Categoria': '', 'Quantidade': '', 'Percentual': '' });
            resumo.push({ 'Categoria': '=== INFORMAÇÕES DE SAÚDE ===', 'Quantidade': '', 'Percentual': '' });
            resumo.push({
                'Categoria': 'Com Alergias',
                'Quantidade': comAlergia,
                'Percentual': `${((comAlergia / total) * 100).toFixed(1)}%`
            });
            resumo.push({
                'Categoria': 'Com Problemas de Saúde',
                'Quantidade': comProblemaSaude,
                'Percentual': `${((comProblemaSaude / total) * 100).toFixed(1)}%`
            });

            // Adicionar tipos sanguíneos
            if (Object.keys(tiposSanguineos).length > 0) {
                resumo.push({ 'Categoria': '', 'Quantidade': '', 'Percentual': '' });
                resumo.push({ 'Categoria': '=== TIPOS SANGUÍNEOS ===', 'Quantidade': '', 'Percentual': '' });

                Object.entries(tiposSanguineos).sort((a, b) => b[1] - a[1]).forEach(([tipo, qtd]) => {
                    resumo.push({
                        'Categoria': tipo,
                        'Quantidade': qtd,
                        'Percentual': `${((qtd / total) * 100).toFixed(1)}%`
                    });
                });
            }

            // Adicionar informações de geração do relatório
            resumo.push({ 'Categoria': '', 'Quantidade': '', 'Percentual': '' });
            resumo.push({ 'Categoria': '=== INFORMAÇÕES DO RELATÓRIO ===', 'Quantidade': '', 'Percentual': '' });
            resumo.push({ 'Categoria': 'Data de Geração', 'Quantidade': new Date().toLocaleDateString('pt-BR'), 'Percentual': '' });
            resumo.push({ 'Categoria': 'Hora de Geração', 'Quantidade': new Date().toLocaleTimeString('pt-BR'), 'Percentual': '' });
            resumo.push({ 'Categoria': 'Sistema', 'Quantidade': 'ED 2025 - Gestão de Inscrições', 'Percentual': '' });

            return resumo;
        }

        // Adicione esta função para atualizar o contador
        function atualizarContador() {
            const participantesFiltrados = dataTable.rows({ search: 'applied' }).count();

            $('#contador-participantes').text(participantesFiltrados);
            $('#total-participantes').text(totalParticipantes);

            // Mostrar ou esconder o texto de filtro
            if (participantesFiltrados < totalParticipantes) {
                $('#texto-filtro').show();
            } else {
                $('#texto-filtro').hide();
            }
        }

        function verDetalhes(participanteId) {
    Promise.all([
        db.collection("Eventos").doc("ED2025").collection("inscricoes").doc(participanteId).get(),
        db.collection("Eventos").doc("ED2025").collection("pagamentos")
            .where("participanteId", "==", participanteId)
            .get()
    ]).then(([inscricaoDoc, pagamentosSnapshot]) => {
        if (inscricaoDoc.exists) {
            const p = inscricaoDoc.data();
    
            // Calcular valores de pagamento
            let valorTotalPago = 0;
            const pagamentos = [];
    
            pagamentosSnapshot.forEach((doc) => {
                const pagamento = doc.data();
                valorTotalPago += parseFloat(pagamento.valor || 0);
                pagamentos.push(pagamento);
            });
    
            const VALOR_TOTAL_INSCRICAO = 350.00;
            const valorRestante = VALOR_TOTAL_INSCRICAO - valorTotalPago;
    
            // Preencher campos de visualização
            $('#modalCodigo').text(p.codigoIdentificador || 'N/A');
            $('#modalNome').text(p.nome || 'N/A');
            $('#modalDtNasc').text(p.dtnasc || 'N/A');
            $('#modalCpf').text(p.cpf || 'N/A');
            $('#modalSexo').text(p.sexo || 'N/A');
            $('#modalEmail').text(p.email || 'N/A');
            $('#modalCelular').text(p.celular || 'N/A');
            $('#modalTamanhoBlusa').text(p.tamanhoBlusa || 'N/A');
            $('#modalIgreja').text(p.igreja || 'N/A');
            $('#modalOutraIgreja').text(p.outraIgreja || 'N/A');
            $('#modalNomePastor').text(p.nomePastor || 'N/A');
            $('#modalCelula').text(p.celula || 'N/A');
            $('#modalSituacaoIgreja').text(p.situacaoIgreja || 'N/A');

            // Preencher campos de edição com os valores atuais
            $('#modalNomeEdit').val(p.nome || '');
            $('#modalDtNascEdit').val(p.dtnasc ? converterDataParaInput(p.dtnasc) : '');
            $('#modalCpfEdit').val(p.cpf || '');
            $('#modalSexoEdit').val(p.sexo || '');
            $('#modalEmailEdit').val(p.email || '');
            $('#modalCelularEdit').val(p.celular || '');
            $('#modalTamanhoBlusaEdit').val(p.tamanhoBlusa || '');
            $('#modalIgrejaEdit').val(p.igreja || '');
            $('#modalOutraIgrejaEdit').val(p.outraIgreja || '');
            $('#modalNomePastorEdit').val(p.nomePastor || '');
            $('#modalCelulaEdit').val(p.celula || '');
            $('#modalSituacaoIgrejaEdit').val(p.situacaoIgreja || '');

            // Configurar visibilidade dos campos condicionais
            configurarVisibilidadeCampos(p.igreja);

            // Informações de Saúde (somente leitura)
            $('#modalTipoSanguineo').text(p.tipoSanguineo || 'N/A');
            $('#modalAlergia').text(p.alergia ? 'SIM' : 'NÃO');
            $('#modalQuaisAlergias').text(p.quaisAlergias || 'N/A');
            $('#modalProblemaSaude').text(p.problemaSaude ? 'SIM' : 'NÃO');
            $('#modalQuaisProblemas').text(p.quaisProblemaSaude || 'N/A');

            // Contatos de Emergência (somente leitura)
            $('#modalContato1').text(p.contato1 || 'N/A');
            $('#modalFoneContato1').text(p.foneContato1 || 'N/A');
            $('#modalContato2').text(p.contato2 || 'N/A');
            $('#modalFoneContato2').text(p.foneContato2 || 'N/A');
            $('#modalContato3').text(p.contato3 || 'N/A');
            $('#modalFoneContato3').text(p.foneContato3 || 'N/A');

            // Informações de Registro
            const statusPagamento = valorTotalPago >= VALOR_TOTAL_INSCRICAO ? 'PAGO' : 
                           valorTotalPago > 0 ? 'PARCIAL' : 'PENDENTE';
    
            $('#modalStatusPagamento').html(`
                <span class="badge ${statusPagamento === 'PAGO' ? 'badge-pago' : 
                           statusPagamento === 'PARCIAL' ? 'badge-parcial' : 'badge-pendente'}">${statusPagamento}</span>
                <br><small>R$ ${valorTotalPago.toFixed(2).replace('.', ',')} / R$ ${VALOR_TOTAL_INSCRICAO.toFixed(2).replace('.', ',')}</small>
                ${valorRestante > 0 ? `<br><small class="text-danger">Restante: R$ ${valorRestante.toFixed(2).replace('.', ',')}</small>` : ''}
            `);
            $('#modalDataPreenchimento').text(p.dataPreenchimento || 'N/A');
            $('#modalDtRegistro').text(p.dtRegistro || 'N/A');
            $('#modalAnoEvento').text(p.anoevento || 'N/A');

            // Configurar IDs nos botões
            $('#btnExcluirParticipante').data('id', participanteId);
            $('#btnEditarParticipante').data('id', participanteId);

            // Garantir que está no modo visualização
            sairModoEdicao();

            // Abrir modal
            $('#participanteModal').modal('show');
        } else {
            console.error("Documento não encontrado para ID:", participanteId);
            alert("Participante não encontrado!");
        }
    })
    .catch((error) => {
        console.error("Erro ao buscar detalhes: ", error);
        alert("Erro ao buscar detalhes do participante.");
    });
}

// Função auxiliar para converter data do formato brasileiro para input date
function converterDataParaInput(dataBrasileira) {
    if (!dataBrasileira) return '';
    
    // Se já estiver no formato YYYY-MM-DD, retornar como está
    if (dataBrasileira.includes('-') && dataBrasileira.length === 10) {
        return dataBrasileira;
    }
    
    // Converter de DD/MM/YYYY para YYYY-MM-DD
    const partes = dataBrasileira.split('/');
    if (partes.length === 3) {
        const dia = partes[0].padStart(2, '0');
        const mes = partes[1].padStart(2, '0');
        const ano = partes[2];
        return `${ano}-${mes}-${dia}`;
    }
    
    return '';
}

// Função para configurar visibilidade dos campos condicionais
function configurarVisibilidadeCampos(igreja) {
    if (igreja === 'Outra') {
        $('#modalOutraIgrejaContainer').show();
        $('#modalNomePastorContainer').show();
        $('#modalCelulaContainer').hide();
    } else if (igreja === 'IEB Intermares') {
        $('#modalOutraIgrejaContainer').hide();
        $('#modalNomePastorContainer').hide();
        $('#modalCelulaContainer').show();
    } else {
        $('#modalOutraIgrejaContainer').hide();
        $('#modalNomePastorContainer').hide();
        $('#modalCelulaContainer').hide();
    }
}


        function aplicarFiltros() {
            const filtroPagamento = $('#filterPagamento').val();
            const filtroIgreja = $('#filterIgreja').val();

            // Limpar filtros anteriores
            dataTable.search('').columns().search('').draw();

            // Aplicar filtro de pagamento
            if (filtroPagamento) {
                let termoBusca = '';
                switch (filtroPagamento) {
                    case 'pago':
                        termoBusca = 'PAGO';
                        break;
                    case 'pendente':
                        termoBusca = 'PENDENTE';
                        break;
                    case 'parcial':
                        termoBusca = 'PARCIAL';
                        break;
                }
                dataTable.column(5).search(termoBusca, true, false);
            }

            // Aplicar filtro de igreja
            if (filtroIgreja) {
                if (filtroIgreja === 'Outra') {
                    dataTable.column(3).search('^(?!IEB Intermares|IEB Cidade Verde|IEB Vila Feliz|IEB Missão Resgate).*', true, false);
                } else {
                    dataTable.column(3).search(filtroIgreja, true, false);
                }
            }

            dataTable.draw();
            atualizarContador();
        }

        function excluirParticipante(participanteId) {
            if (!participanteId) {
                alert("Erro: Não foi possível identificar o participante para exclusão.");
                return;
            }

            if (confirm("Tem certeza que deseja excluir este participante? Esta ação não pode ser desfeita.")) {
                db.collection("Eventos").doc("ED2025").collection("inscricoes").doc(participanteId)
                    .delete()
                    .then(() => {
                        alert("Participante excluído com sucesso!");
                        $('#participanteModal').modal('hide');
                        setTimeout(function () {
                            carregarParticipantes(); // Recarrega a lista após exclusão
                        }, 500);
                    })
                    .catch((error) => {
                        alert("Erro ao excluir participante: " + error.message);
                    });
            }
        }

        // Event listeners para edição
$('#btnEditarParticipante').on('click', function() {
    const participanteId = $(this).data('id') || $('#btnExcluirParticipante').data('id');
    if (participanteId) {
        entrarModoEdicao(participanteId);
    }
});

$('#btnCancelarEdicao').on('click', function() {
    if (confirm('Deseja cancelar as alterações? Todos os dados não salvos serão perdidos.')) {
        restaurarDadosOriginais();
        sairModoEdicao();
    }
});

$('#btnSalvarEdicao').on('click', function() {
    salvarAlteracoes();
});

// Configurar o botão de exclusão (mantém o código existente)
$('#btnExcluirParticipante').on('click', function () {
    const participanteId = $(this).data('id');
    if (!participanteId) {
        alert("Erro: Não foi possível identificar o participante para exclusão.");
    } else {
        excluirParticipante(participanteId);
    }
});

// Prevenir fechamento acidental durante edição
$('#participanteModal').on('hide.bs.modal', function (e) {
    if (modoEdicao) {
        if (!confirm('Você está editando dados. Deseja sair sem salvar?')) {
            e.preventDefault();
            return false;
        } else {
            sairModoEdicao();
        }
    }
    // Remover o foco de todos os elementos focáveis dentro do modal
    $(this).find('button, input, select, textarea, a[href]').blur();
});

// Variáveis globais para controle de edição
let modoEdicao = false;
let dadosOriginais = {};

// Função para entrar no modo de edição
function entrarModoEdicao(participanteId) {
    modoEdicao = true;
    
    // Armazenar dados originais para possível cancelamento
    dadosOriginais = {
        nome: $('#modalNome').text(),
        dtnasc: $('#modalDtNasc').text(),
        cpf: $('#modalCpf').text(),
        sexo: $('#modalSexo').text(),
        email: $('#modalEmail').text(),
        celular: $('#modalCelular').text(),
        tamanhoBlusa: $('#modalTamanhoBlusa').text(),
        igreja: $('#modalIgreja').text(),
        outraIgreja: $('#modalOutraIgreja').text(),
        nomePastor: $('#modalNomePastor').text(),
        celula: $('#modalCelula').text(),
        situacaoIgreja: $('#modalSituacaoIgreja').text()
    };
    
    // Adicionar classe de modo edição
    $('#participanteModal .modal-content').addClass('modo-edicao');
    
    // Mostrar campos de edição e esconder visualização
    $('.campo-visualizacao').hide();
    $('.campo-edicao').show();
    
    // Trocar botões
    $('#botoesVisualizacao').hide();
    $('#botoesEdicao').show();
    
    // Configurar evento de mudança da igreja para campos condicionais
    $('#modalIgrejaEdit').on('change', function() {
        configurarVisibilidadeCampos($(this).val());
    });
    
    // Armazenar ID do participante para salvar
    $('#btnSalvarEdicao').data('id', participanteId);
}

// Função para sair do modo de edição
function sairModoEdicao() {
    modoEdicao = false;
    
    // Remover classe de modo edição
    $('#participanteModal .modal-content').removeClass('modo-edicao');
    
    // Mostrar campos de visualização e esconder edição
    $('.campo-visualizacao').show();
    $('.campo-edicao').hide();
    
    // Trocar botões
    $('#botoesVisualizacao').show();
    $('#botoesEdicao').hide();
    
    // Limpar dados originais
    dadosOriginais = {};
}

// Função para restaurar dados originais
function restaurarDadosOriginais() {
    if (Object.keys(dadosOriginais).length > 0) {
        $('#modalNome').text(dadosOriginais.nome);
        $('#modalDtNasc').text(dadosOriginais.dtnasc);
        $('#modalCpf').text(dadosOriginais.cpf);
        $('#modalSexo').text(dadosOriginais.sexo);
        $('#modalEmail').text(dadosOriginais.email);
        $('#modalCelular').text(dadosOriginais.celular);
        $('#modalTamanhoBlusa').text(dadosOriginais.tamanhoBlusa);
        $('#modalIgreja').text(dadosOriginais.igreja);
        $('#modalOutraIgreja').text(dadosOriginais.outraIgreja);
        $('#modalNomePastor').text(dadosOriginais.nomePastor);
        $('#modalCelula').text(dadosOriginais.celula);
        $('#modalSituacaoIgreja').text(dadosOriginais.situacaoIgreja);
        
        // Restaurar valores dos campos de edição
        $('#modalNomeEdit').val(dadosOriginais.nome);
        $('#modalDtNascEdit').val(converterDataParaInput(dadosOriginais.dtnasc));
        $('#modalCpfEdit').val(dadosOriginais.cpf);
        $('#modalSexoEdit').val(dadosOriginais.sexo);
        $('#modalEmailEdit').val(dadosOriginais.email);
        $('#modalCelularEdit').val(dadosOriginais.celular);
        $('#modalTamanhoBlusaEdit').val(dadosOriginais.tamanhoBlusa);
        $('#modalIgrejaEdit').val(dadosOriginais.igreja);
        $('#modalOutraIgrejaEdit').val(dadosOriginais.outraIgreja);
        $('#modalNomePastorEdit').val(dadosOriginais.nomePastor);
        $('#modalCelulaEdit').val(dadosOriginais.celula);
        $('#modalSituacaoIgrejaEdit').val(dadosOriginais.situacaoIgreja);
    }
}

// Função para salvar alterações
function salvarAlteracoes() {
    const participanteId = $('#btnSalvarEdicao').data('id');
    
    if (!participanteId) {
        alert('Erro: Não foi possível identificar o participante para salvar.');
        return;
    }
    
    // Validar campos obrigatórios
    const nome = $('#modalNomeEdit').val().trim();
    const email = $('#modalEmailEdit').val().trim();
    const celular = $('#modalCelularEdit').val().trim();
    
    if (!nome) {
        alert('O nome é obrigatório.');
        $('#modalNomeEdit').focus();
        return;
    }
    
    if (!email) {
        alert('O email é obrigatório.');
        $('#modalEmailEdit').focus();
        return;
    }
    
    if (!celular) {
        alert('O celular é obrigatório.');
        $('#modalCelularEdit').focus();
        return;
    }
    
    // Preparar dados para atualização
    const dadosAtualizados = {
        nome: nome,
        dtnasc: converterDataDeInput($('#modalDtNascEdit').val()),
        cpf: $('#modalCpfEdit').val().trim(),
        sexo: $('#modalSexoEdit').val(),
        email: email,
        celular: celular,
        tamanhoBlusa: $('#modalTamanhoBlusaEdit').val(),
        igreja: $('#modalIgrejaEdit').val(),
        outraIgreja: $('#modalOutraIgrejaEdit').val().trim(),
        nomePastor: $('#modalNomePastorEdit').val().trim(),
        celula: $('#modalCelulaEdit').val(),
        situacaoIgreja: $('#modalSituacaoIgrejaEdit').val(),
        // Adicionar timestamp de última atualização
        ultimaAtualizacao: new Date().toISOString()
    };
    
    // Limpar campos condicionais se não aplicáveis
    if (dadosAtualizados.igreja !== 'Outra') {
        dadosAtualizados.outraIgreja = '';
        dadosAtualizados.nomePastor = '';
    }
    
    if (dadosAtualizados.igreja !== 'IEB Intermares') {
        dadosAtualizados.celula = '';
    }
    
    // Salvar no Firebase
    db.collection("Eventos").doc("ED2025").collection("inscricoes").doc(participanteId)
        .update(dadosAtualizados)
        .then(() => {
            alert('Dados atualizados com sucesso!');
            
            // Atualizar campos de visualização com os novos dados
            $('#modalNome').text(dadosAtualizados.nome);
            $('#modalDtNasc').text(dadosAtualizados.dtnasc);
            $('#modalCpf').text(dadosAtualizados.cpf);
            $('#modalSexo').text(dadosAtualizados.sexo);
            $('#modalEmail').text(dadosAtualizados.email);
            $('#modalCelular').text(dadosAtualizados.celular);
            $('#modalTamanhoBlusa').text(dadosAtualizados.tamanhoBlusa);
            $('#modalIgreja').text(dadosAtualizados.igreja);
            $('#modalOutraIgreja').text(dadosAtualizados.outraIgreja);
            $('#modalNomePastor').text(dadosAtualizados.nomePastor);
            $('#modalCelula').text(dadosAtualizados.celula);
            $('#modalSituacaoIgreja').text(dadosAtualizados.situacaoIgreja);
            
            // Configurar visibilidade dos campos
            configurarVisibilidadeCampos(dadosAtualizados.igreja);
            
            // Sair do modo edição
            sairModoEdicao();
            
            // Recarregar a lista para refletir as mudanças
            setTimeout(() => {
                carregarParticipantes();
            }, 1000);
        })
        .catch((error) => {
            console.error('Erro ao salvar alterações:', error);
            alert('Erro ao salvar alterações: ' + error.message);
        });
}

// Função auxiliar para converter data do input date para formato brasileiro
function converterDataDeInput(dataInput) {
    if (!dataInput) return '';
    
    // Se já estiver no formato DD/MM/YYYY, retornar como está
    if (dataInput.includes('/')) {
        return dataInput;
    }
    
    // Converter de YYYY-MM-DD para DD/MM/YYYY
    const partes = dataInput.split('-');
    if (partes.length === 3) {
        const ano = partes[0];
        const mes = partes[1];
        const dia = partes[2];
        return `${dia}/${mes}/${ano}`;
    }
    
    return dataInput;
}


    </script>
</body>

</html>