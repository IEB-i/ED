<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuição de Salas</title>
    <link rel="shortcut icon" href="../assets/3.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            border-radius: 10px 10px 0 0;
            font-weight: bold;
        }

        .Sala-card {
            background: linear-gradient(45deg, #3d7517, #4a8c20);
            color: white;
        }

        .Sala-badge {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .Sala-verde {
            background-color: #28a745;
            color: white;
        }

        .Sala-amarela {
            background-color: #ffc107;
            color: black;
        }

        .Sala-laranja {
            background-color: #fd7e14;
            color: white;
        }

        .Sala-vermelha {
            background-color: #dc3545;
            color: white;
        }

        .sem-Sala {
            background-color: #6c757d;
            color: white;
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar:hover {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .btn-voltar .material-icons {
            font-size: 24px;
        }

        .sort-btn {
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            transform: scale(1.2);
        }

        .sort-btn:focus {
            outline: none;
            box-shadow: none;
        }

        .sort-asc .material-icons {
            transform: rotate(180deg);
        }

        .filtro-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Header de Estatísticas */
        .stats-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .stats-card {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stats-icon {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 30px;
        }

        .stats-icon i {
            font-size: 40px;
            color: white;
        }

        .stats-content h3 {
            font-size: 3rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stats-content p {
            font-size: 1.2rem;
            margin: 5px 0;
            opacity: 0.9;
        }

        .stats-content small {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        /* Grid de Salas */
        .salas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .sala-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .sala-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            transition: all 0.3s ease;
        }

        .sala-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        /* Cores específicas para cada sala */
        .sala-verde::before {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .sala-amarela::before {
            background: linear-gradient(90deg, #FFC107, #FFEB3B);
        }

        .sala-laranja::before {
            background: linear-gradient(90deg, #FF9800, #FF5722);
        }

        .sala-vermelha::before {
            background: linear-gradient(90deg, #F44336, #E91E63);
        }

        .sala-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .sala-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
        }

        .sala-verde .sala-icon {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .sala-amarela .sala-icon {
            background: linear-gradient(135deg, #FFC107, #FFEB3B);
        }

        .sala-laranja .sala-icon {
            background: linear-gradient(135deg, #FF9800, #FF5722);
        }

        .sala-vermelha .sala-icon {
            background: linear-gradient(135deg, #F44336, #E91E63);
        }

        .sala-info h4 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .idade-range {
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sala-stats {
            text-align: center;
        }

        .count-display {
            margin-bottom: 15px;
        }

        .count {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .max-count {
            font-size: 1.2rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        /* Progress Bar Moderno */
        .progress-modern {
            height: 8px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: all 0.6s ease;
            position: relative;
        }

        .sala-verde .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .sala-amarela .progress-fill {
            background: linear-gradient(90deg, #FFC107, #FFEB3B);
        }

        .sala-laranja .progress-fill {
            background: linear-gradient(90deg, #FF9800, #FF5722);
        }

        .sala-vermelha .progress-fill {
            background: linear-gradient(90deg, #F44336, #E91E63);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .percentage {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        /* Indicadores de Status */
        .sala-card.warning::before {
            background: linear-gradient(90deg, #f39c12, #e67e22) !important;
        }

        .sala-card.danger::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b) !important;
        }

        .sala-card.full::before {
            background: linear-gradient(90deg, #2c3e50, #34495e) !important;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .stats-header {
                padding: 20px;
                text-align: center;
            }

            .stats-card {
                flex-direction: column;
            }

            .stats-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .salas-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .sala-card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">DISTRIBUIÇÃO DE SALAS</h2>
    </div>

    <div class="container mt-5">
        <!-- Header com estatísticas gerais -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="stats-header">
                    <div class="stats-card total-participants">
                        <div class="stats-icon">
                            <i class="material-icons">groups</i>
                        </div>
                        <div class="stats-content">
                            <h3 id="totalParticipantes">0</h3>
                            <p>Participantes com Check-in Realizados</p>
                            <small>Total confirmado</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid de Salas Moderno -->
        <div class="row">
            <div class="col-12">
                <div class="salas-grid">
                    <div class="sala-card sala-verde">
                        <div class="sala-header">
                            <div class="sala-icon">
                                <i class="material-icons">nature</i>
                            </div>
                            <div class="sala-info">
                                <h4>Sala Verde</h4>
                                <span class="idade-range">4-5 anos</span>
                            </div>
                        </div>
                        <div class="sala-stats">
                            <div class="count-display">
                                <span class="count" id="totalSala1">0</span>
                                <span class="max-count">/ 30</span>
                            </div>
                            <div class="progress-modern">
                                <div class="progress-fill" id="progressSala1" style="width: 0%"></div>
                            </div>
                            <div class="percentage" id="percentSala1">0%</div>
                        </div>
                    </div>

                    <div class="sala-card sala-amarela">
                        <div class="sala-header">
                            <div class="sala-icon">
                                <i class="material-icons">wb_sunny</i>
                            </div>
                            <div class="sala-info">
                                <h4>Sala Amarela</h4>
                                <span class="idade-range">6-7 anos</span>
                            </div>
                        </div>
                        <div class="sala-stats">
                            <div class="count-display">
                                <span class="count" id="totalSala2">0</span>
                                <span class="max-count">/ 30</span>
                            </div>
                            <div class="progress-modern">
                                <div class="progress-fill" id="progressSala2" style="width: 0%"></div>
                            </div>
                            <div class="percentage" id="percentSala2">0%</div>
                        </div>
                    </div>

                    <div class="sala-card sala-laranja">
                        <div class="sala-header">
                            <div class="sala-icon">
                                <i class="material-icons">local_fire_department</i>
                            </div>
                            <div class="sala-info">
                                <h4>Sala Laranja</h4>
                                <span class="idade-range">8-9 anos</span>
                            </div>
                        </div>
                        <div class="sala-stats">
                            <div class="count-display">
                                <span class="count" id="totalSala3">0</span>
                                <span class="max-count">/ 30</span>
                            </div>
                            <div class="progress-modern">
                                <div class="progress-fill" id="progressSala3" style="width: 0%"></div>
                            </div>
                            <div class="percentage" id="percentSala3">0%</div>
                        </div>
                    </div>

                    <div class="sala-card sala-vermelha">
                        <div class="sala-header">
                            <div class="sala-icon">
                                <i class="material-icons">sports_esports</i>
                            </div>
                            <div class="sala-info">
                                <h4>Sala Vermelha</h4>
                                <span class="idade-range">10-12 anos</span>
                            </div>
                        </div>
                        <div class="sala-stats">
                            <div class="count-display">
                                <span class="count" id="totalSala4">0</span>
                                <span class="max-count">/ 30</span>
                            </div>
                            <div class="progress-modern">
                                <div class="progress-fill" id="progressSala4" style="width: 0%"></div>
                            </div>
                            <div class="percentage" id="percentSala4">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Container Filtros -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="filtro-container">
                    <div class="row">
                        <!-- Filtro Buscar Nomes -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filtroNome">Buscar por nome</label>
                                <input type="text" class="form-control" id="filtroNome"
                                    placeholder="Digite o nome do participante">
                            </div>
                        </div>

                        <!-- Filtro Salas -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filtroSala">Filtrar por Sala</label>
                                <select class="form-control" id="filtroSala">
                                    <option value="todos">Todos as Sala</option>
                                    <option value="Verde">Sala Verde</option>
                                    <option value="Amarela">Sala Amarela</option>
                                    <option value="Laranja">Sala Laranja</option>
                                    <option value="Vermelha">Sala Vermelha</option>
                                    <option value="sem">Sem Sala</option>
                                </select>
                            </div>
                        </div>

                        <!-- Ordenação Manual -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ordenacao">Ordenar por</label>
                                <select class="form-control" id="ordenacao">
                                    <option value="nome">Nome</option>
                                    <option value="idade">Idade</option>
                                    <option value="data">Data de inscrição</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Estrutura da Tabela -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <!--  título Antes da Tabela-->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Participantes com Checkin Confirmado</span>
                        <div>
                            <button class="btn btn-success btn-sm" id="btnSalvarDistribuicao">
                                <i class="material-icons">save</i> Salvar Distribuição
                            </button>
                            <button class="btn btn-primary btn-sm ml-2" id="btnExportarLista">
                                <i class="material-icons">cloud_download</i> Exportar Lista
                            </button>
                        </div>
                    </div>

                    <!-- Tabela -->
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="participantesTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>
                                            <div class="d-flex align-items-center">
                                                Nome
                                                <button class="btn btn-sm text-white ml-2 sort-btn" data-sort="nome">
                                                    <i class="material-icons" id="sortIconNome">sort</i>
                                                </button>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="d-flex align-items-center">
                                                Idade
                                                <button class="btn btn-sm text-white ml-2 sort-btn" data-sort="idade">
                                                    <i class="material-icons" id="sortIconIdade">sort</i>
                                                </button>
                                            </div>
                                        </th>
                                        <th>Telefone</th>
                                        <th>Sala Atual</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="participantesList">
                                    <!-- Os dados serão carregados dinamicamente do Firebase -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Atribuição de Sala -->
    <div class="modal fade" id="atribuirSalaModal" tabindex="-1" role="dialog" aria-labelledby="atribuirSalaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="atribuirSalaModalLabel">Atribuir Sala</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="atribuirSalaForm">
                        <input type="hidden" id="participanteId">

                        <div class="form-group">
                            <label for="participanteNome">Participante</label>
                            <input type="text" class="form-control" id="participanteNome" readonly>
                        </div>

                        <div class="form-group">
                            <label for="SalaNumero">Selecione a Sala</label>
                            <select class="form-control" id="SalaNumero" required>
                                <option value="">Selecione...</option>
                                <option value="Verde">Sala Verde (4-5 anos)</option>
                                <option value="Amarela">Sala Amarela (6-7 anos)</option>
                                <option value="Laranja">Sala Laranja (8-9 anos)</option>
                                <option value="Vermelha">Sala Vermelha (10-12 anos)</option>
                                <option value="sem">Sem Sala</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="observacoes">Observações (opcional)</label>
                            <textarea class="form-control" id="observacoes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarAtribuicao">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exportação -->
    <div class="modal fade" id="exportarModal" tabindex="-1" role="dialog" aria-labelledby="exportarModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportarModalLabel">Exportar Lista de Sala</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="formatoExportacao">Formato de Exportação</label>
                        <select class="form-control" id="formatoExportacao">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="SalaExportar">Sala para Exportar</label>
                        <select class="form-control" id="SalaExportar">
                            <option value="todos">Todos os Sala</option>
                            <option value="verde">Apenas Sala Verde</option>
                            <option value="amarelo">Apenas Sala Amarelo</option>
                            <option value="laranja">Apenas Sala Laranja</option>
                            <option value="vermelha">Apenas Sala Vermelha</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="incluirContatos">
                        <label class="form-check-label" for="incluirContatos">Incluir informações de contato</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarExportacao">Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="../firebase/firebaseConfig.js"></script>

    <script>
        // Variáveis globais
        let todosParticipantes = [];
        let participantesFiltrados = [];
        let sortConfig = {
            field: 'idade',
            direction: 'asc'
        };

        // Capacidade máxima de cada Sala
        const CAPACIDADE_Sala = 30;

        // Usar nomes consistentes em vez de números
        const SALAS_CONFIG = {
            'Verde': { id: 1, faixaEtaria: '4-5 anos', cor: '#28a745' },
            'Amarela': { id: 2, faixaEtaria: '6-7 anos', cor: '#ffc107' },
            'Laranja': { id: 3, faixaEtaria: '8-9 anos', cor: '#fd7e14' },
            'Vermelha': { id: 4, faixaEtaria: '10-12 anos', cor: '#dc3545' }
        };

        $(document).ready(function () {
            // Carregar dados iniciais
            carregarParticipantes();

            // Configurar eventos de filtro
            $('#filtroNome').on('input', aplicarFiltros);
            $('#filtroSala').on('change', aplicarFiltros);
            $('#ordenacao').on('change', aplicarFiltros);

            // Configurar evento de ordenação
            $('.sort-btn').on('click', function () {
                const sortField = $(this).data('sort');

                // Se clicar no mesmo campo, inverte a direção
                if (sortField === sortConfig.field) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // Se clicar em um campo diferente, define o novo campo e direção padrão (asc)
                    sortConfig.field = sortField;
                    sortConfig.direction = 'asc';
                }

                // Atualizar ícone
                updateSortIcon();

                // Aplicar a ordenação
                aplicarFiltros();
            });

            // Configurar evento para salvar atribuição de Sala
            $('#salvarAtribuicao').on('click', function () {
                const participanteId = $('#participanteId').val();
                const SalaNumero = $('#SalaNumero').val();
                const observacoes = $('#observacoes').val();

                if (!SalaNumero) {
                    alert('Por favor, selecione um Sala.');
                    return;
                }

                // Atualizar o participante no Firestore
                db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participanteId)
                    .update({
                        sala: SalaNumero === 'sem' ? null : SalaNumero,
                        observacoesSala: observacoes,
                        dataAtualizacaoSala: new Date().toLocaleString('pt-BR')
                    })
                    .then(() => {
                        alert('Sala atribuído com sucesso!');
                        $('#atribuirSalaModal').modal('hide');

                        // Atualizar o participante na lista local
                        const index = todosParticipantes.findIndex(p => p.id === participanteId);
                        if (index !== -1) {
                            todosParticipantes[index].sala = SalaNumero === 'sem' ? null : SalaNumero;
                            todosParticipantes[index].observacoesSala = observacoes;
                        }

                        // Recarregar dados
                        aplicarFiltros();
                        atualizarContadores();
                    })
                    .catch((error) => {
                        console.error("Erro ao atribuir Sala: ", error);
                        alert("Erro ao atribuir Sala. Tente novamente.");
                    });
            });

            // Configurar evento para salvar toda a distribuição
            $('#btnSalvarDistribuicao').on('click', function () {
                salvarDistribuicao();
            });

            // Configurar evento para exportar lista
            $('#btnExportarLista').on('click', function () {
                $('#exportarModal').modal('show');
            });

            // Configurar evento para confirmar exportação
            $('#confirmarExportacao').on('click', function () {
                exportarLista();
                $('#exportarModal').modal('hide');
            });
        });

        function carregarParticipantes() {
            // Buscar participantes com Checkin Realizado
            db.collection("Eventos").doc("EBF2025").collection("inscricoes")
                .where("anoevento", "==", "2025")
                .where("tipoInsc", "==", "criancas")
                .where("statusCheckin", "==", "realizado")
                .get()
                .then((querySnapshot) => {
                    todosParticipantes = [];

                    querySnapshot.forEach((doc) => {
                        const participante = doc.data();
                        participante.id = doc.id;
                        todosParticipantes.push(participante);
                    });

                    // Aplicar filtros iniciais
                    aplicarFiltros();

                    // Atualizar contadores
                    atualizarContadores();
                })
                .catch((error) => {
                    console.error("Erro ao carregar participantes:", error);
                    alert("Erro ao carregar participantes. Tente novamente.");
                });
        }

        function aplicarFiltros() {
            const filtroNome = $('#filtroNome').val().toLowerCase();
            const filtroSala = $('#filtroSala').val();

            // Aplicar filtros
            participantesFiltrados = todosParticipantes.filter(participante => {
                // Filtro por nome
                const nomeMatch = participante.nome.toLowerCase().includes(filtroNome);

                // Filtro por Sala
                let SalaMatch = true;
                if (filtroSala !== 'todos') {
                    if (filtroSala === 'sem') {
                        SalaMatch = !participante.sala;
                    } else {
                        SalaMatch = participante.sala === filtroSala;
                    }
                }

                return nomeMatch && SalaMatch;
            });

            // Aplicar ordenação
            participantesFiltrados.sort((a, b) => {
                let valorA, valorB;

                // Determinar os valores a comparar com base no campo de ordenação
                switch (sortConfig.field) {
                    case 'nome':
                        valorA = a.nome.toLowerCase();
                        valorB = b.nome.toLowerCase();
                        break;
                    case 'idade':
                        // Usar o campo idade diretamente
                        valorA = parseInt(a.idade || 0);
                        valorB = parseInt(b.idade || 0);
                        break;
                    case 'data':
                        valorA = new Date(a.dataInscricao || 0);
                        valorB = new Date(b.dataInscricao || 0);
                        break;
                    default:
                        valorA = a.nome.toLowerCase();
                        valorB = b.nome.toLowerCase();
                }

                // Comparar os valores na direção especificada
                if (sortConfig.direction === 'asc') {
                    return valorA > valorB ? 1 : -1;
                } else {
                    return valorA < valorB ? 1 : -1;
                }
            });

            // Atualizar a tabela
            atualizarTabelaParticipantes();
        }

        function atualizarTabelaParticipantes() {
            const tabelaParticipantes = $('#participantesList');
            tabelaParticipantes.html('');

            if (participantesFiltrados.length === 0) {
                tabelaParticipantes.html('<tr><td colspan="5" class="text-center">Nenhum participante encontrado</td></tr>');
                return;
            }

            participantesFiltrados.forEach(participante => {
                // Usar o campo idade diretamente sem adicionar "anos"
                const idade = participante.idade || '';
                const telefone = formatarTelefone(participante.telefone || participante.foneResponsavel);

                // Determinar a classe do badge de Sala
                let SalaClass = 'sem-Sala';
                let SalaText = 'Sem Sala';

                if (participante.sala) {
                    SalaClass = `Sala-${participante.sala.toLowerCase()}`;
                    SalaText = `${participante.sala}`;
                }

                const linha = `
                <tr id="participante-${participante.id}">
                    <td>${participante.nome}</td>
                    <td>${idade}</td>
                    <td>${telefone}</td>
                    <td><span class="badge Sala-badge ${SalaClass}">${SalaText}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="prepararAtribuicao('${participante.id}')">
                            <i class="material-icons">meeting_room</i>
                        </button>
                    </td>
                </tr>
                `;

                tabelaParticipantes.append(linha);
            });
        }

        function atualizarContadores() {
            // Total de participantes com Checkin confirmado
            $('#totalParticipantes').text(todosParticipantes.length);

            // Contar participantes por todas as 4 salas
            const contagem = {
                verde: 0,
                amarela: 0,
                laranja: 0,
                vermelha: 0
            };

            todosParticipantes.forEach(participante => {
                if (participante.sala === 'Verde') contagem.verde++;
                if (participante.sala === 'Amarela') contagem.amarela++;
                if (participante.sala === 'Laranja') contagem.laranja++;
                if (participante.sala === 'Vermelha') contagem.vermelha++;
            });

            // Atualizar contadores e porcentagens
            const salas = [
                { id: 1, count: contagem.verde, selector: '.sala-verde' },
                { id: 2, count: contagem.amarela, selector: '.sala-amarela' },
                { id: 3, count: contagem.laranja, selector: '.sala-laranja' },
                { id: 4, count: contagem.vermelha, selector: '.sala-vermelha' }
            ];

            salas.forEach(sala => {
                const porcentagem = (sala.count / CAPACIDADE_Sala) * 100;

                // Atualizar números
                $(`#totalSala${sala.id}`).text(sala.count);
                $(`#percentSala${sala.id}`).text(`${Math.round(porcentagem)}%`);

                // Atualizar barra de progresso
                $(`#progressSala${sala.id}`).css('width', `${porcentagem}%`);

                // Adicionar classes de status
                const $card = $(sala.selector);
                $card.removeClass('warning danger full');

                if (porcentagem >= 100) {
                    $card.addClass('full');
                } else if (porcentagem >= 90) {
                    $card.addClass('danger');
                } else if (porcentagem >= 75) {
                    $card.addClass('warning');
                }
            });
        }

        function prepararAtribuicao(participanteId) {
            const participante = todosParticipantes.find(p => p.id === participanteId);

            if (!participante) {
                alert('Participante não encontrado!');
                return;
            }

            // Preencher o formulário com os dados do participante
            $('#participanteId').val(participanteId);
            $('#participanteNome').val(participante.nome);
            $('#SalaNumero').val(participante.sala || '');
            $('#observacoes').val(participante.observacoesSala || '');

            // Abrir o modal
            $('#atribuirSalaModal').modal('show');
        }

        function removerDoSala(participanteId) {
            if (confirm('Tem certeza que deseja remover este participante do Sala?')) {
                // Atualizar o participante no Firestore
                db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participanteId)
                    .update({
                        sala: null,
                        observacoesSala: null,
                        dataAtualizacaoSala: new Date().toISOString()
                    })
                    .then(() => {
                        // Atualizar o participante na lista local
                        const index = todosParticipantes.findIndex(p => p.id === participanteId);
                        if (index !== -1) {
                            todosParticipantes[index].sala = null;
                            todosParticipantes[index].observacoesSala = null;
                        }

                        // Recarregar dados
                        aplicarFiltros();
                        atualizarContadores();
                    })
                    .catch((error) => {
                        console.error("Erro ao remover do Sala: ", error);
                        alert("Erro ao remover do Sala. Tente novamente.");
                    });
            }
        }

        function salvarDistribuicao() {
            // Criar um lote de operações para atualizar todos os participantes de uma vez
            const batch = db.batch();

            // Contador para verificar quantos participantes serão atualizados
            let contadorAtualizacoes = 0;

            // Iterar sobre todos os participantes
            todosParticipantes.forEach(participante => {
                const ref = db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participante.id);

                // Adicionar operação ao lote
                batch.update(ref, {
                    sala: participante.sala,
                    observacoesSala: participante.observacoesSala,
                    dataAtualizacaoSala: new Date().toISOString()
                });

                contadorAtualizacoes++;
            });

            // Executar o lote de operações
            if (contadorAtualizacoes > 0) {
                batch.commit()
                    .then(() => {
                        alert(`Distribuição de Sala salva com sucesso! ${contadorAtualizacoes} participantes atualizados.`);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar distribuição: ", error);
                        alert("Erro ao salvar distribuição. Tente novamente.");
                    });
            } else {
                alert("Nenhuma alteração para salvar.");
            }
        }

        function exportarLista() {
            const formato = $('#formatoExportacao').val();
            const SalaExportar = $('#SalaExportar').val();
            const incluirContatos = $('#incluirContatos').is(':checked');

            // Filtrar participantes pelo Sala selecionado
            let participantesExportar = [...todosParticipantes];

            if (SalaExportar !== 'todos') {
                participantesExportar = participantesExportar.filter(p => p.Sala === SalaExportar);
            }

            // Ordenar por Sala e depois por nome
            participantesExportar.sort((a, b) => {
                if (a.Sala !== b.Sala) {
                    // Se um tem Sala e outro não, o com Sala vem primeiro
                    if (!a.Sala) return 1;
                    if (!b.Sala) return -1;
                    // Ambos têm Sala, ordenar por número
                    return a.Sala.localeCompare(b.Sala);
                }
                // Mesmo Sala, ordenar por nome
                return a.nome.localeCompare(b.nome);
            });

            // Preparar dados para exportação
            const dados = participantesExportar.map(p => {
                const item = {
                    'Nome': p.nome,
                    'Idade': p.idade || '',  // Sem adicionar "anos"
                    'Sala': p.Sala ? `Sala ${p.Sala}` : 'Sem Sala',
                    'Observações': p.observacoesSala || ''
                };

                // Adicionar informações de contato se solicitado
                if (incluirContatos) {
                    item['Telefone'] = formatarTelefone(p.telefone);
                    item['Email'] = p.email || '';
                    item['Responsável'] = p.nomeResponsavel || '';
                    item['Telefone Responsável'] = formatarTelefone(p.telefoneResponsavel);
                }

                return item;
            });

            // Exportar no formato selecionado
            switch (formato) {
                case 'excel':
                    exportarExcel(dados);
                    break;
                case 'csv':
                    exportarCSV(dados);
                    break;
                case 'pdf':
                    exportarPDF(dados);
                    break;
            }
        }

        function exportarExcel(dados) {
            // Criar uma planilha
            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Distribuição de Sala");

            // Gerar arquivo Excel
            const nomeArquivo = `Distribuicao_Sala_AcampBT2025_${formatarDataArquivo(new Date())}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
        }

        function exportarCSV(dados) {
            // Converter dados para CSV
            const ws = XLSX.utils.json_to_sheet(dados);
            const csv = XLSX.utils.sheet_to_csv(ws);

            // Criar blob e download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const nomeArquivo = `Distribuicao_Sala_AcampBT2025_${formatarDataArquivo(new Date())}.csv`;
            saveAs(blob, nomeArquivo);
        }

        function exportarPDF(dados) {
            alert("Exportação para PDF não implementada. Por favor, escolha Excel ou CSV.");
            // A implementação de PDF requer bibliotecas adicionais como jsPDF
        }

        function formatarTelefone(telefone) {
            if (!telefone) return '';

            // Remover caracteres não numéricos
            const numeros = telefone.replace(/\D/g, '');

            // Formatar como (XX) XXXXX-XXXX ou (XX) XXXX-XXXX
            if (numeros.length === 11) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 7)}-${numeros.substring(7)}`;
            } else if (numeros.length === 10) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 6)}-${numeros.substring(6)}`;
            }

            return telefone;
        }

        function formatarDataArquivo(data) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');

            return `${dia}-${mes}-${ano}_${hora}-${minuto}`;
        }

        function updateSortIcon() {
            // Remover classes de todos os ícones
            $('.sort-btn').removeClass('sort-asc sort-desc');

            // Adicionar classe ao ícone atual
            $(`.sort-btn[data-sort="${sortConfig.field}"]`).addClass(
                sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc'
            );
        }
    </script>
</body>

</html>
<link rel="stylesheet" href="../css/common.css">